!function(o){"use strict";_.extend(vc.atts,vcTable.param);var t=Backbone.View.extend({tagName:"div",initialization:!1,events:{"change select,input":"updateValue","click input":"updateValue","click [data-selector-name]":"updateSelectorValue","mousedown a.wp-color-result":"colorPickerCheck"},initialize:function(){_.bindAll(this,"updateColorPicker","clearColorPicker")},attr:{},className:"vc_table_header",template:vc.template(o("#vc_table_param_toolbar").html(),{evaluate:/<#([\s\S]+?)#>/g,interpolate:/\{\{\{([\s\S]+?)\}\}\}/g,escape:/\{\{([^\}]+?)\}\}(?!\})/g}),parent_view:!1,setParentView:function(t){return this.parent_view=t,this},render:function(){return this.parent_view&&(this.$el.html(this.template()),o(".vc_table_color_picker",this.$el).wpColorPicker({change:this.updateColorPicker,clear:this.clearColorPicker})),this},afterAppend:function(){o(".dropdown-toggle",this.$el).dropdown()},build:function(t){this.initialization=!0,this.disableAll(),this.attr=t,_.each(this.attr,function(t,e){var s=o("[data-name="+e+"]",this.$el);s.is(":checkbox")?s.prop("checked",!0):s.hasClass("vc_table_color_picker")?s.wpColorPicker("color",t):"selector"===s.data("type")?this.setSelectorValue(s,t):s.val(t)},this),this.initialization=!1},disableAll:function(){this.$el.find("[type=checkbox]").attr("checked",!1),this.$el.find("select").val(""),o(".vc_table_color_picker",this.$el).each(function(){o(this).val("").trigger("change")}),o(".dropdown-toggle",this.$el).each(function(){var t=o(this);"icons"===t.data("content-type")?t.html('<span class="'+t.data("icon-class")+"-"+t.data("default")+'"></span><span class="caret"></span>'):t.html(t.data("default")+' <span class="caret"></span>')})},setSelectorValue:function(t,e){var s,a=t.find(".dropdown-toggle");"icons"!==a.data("content-type")||_.isEmpty(e)?_.isEmpty(e)||a.html(e+'<span class="caret"></span>'):(s=a.data("icon-class"),a.html('<span class="'+s+"-"+e+'"></span><span class="caret"></span>'))},updateValue:function(t){if(this.initialization)return!1;var e,s,a;s=(e=o(t.currentTarget)).data("name"),a=e.is(":checkbox")?!!e.is(":checked")&&e.val():e.val(),this.save(s,a)},colorPickerCheck:function(t){o(t.currentTarget).hasClass("wp-picker-open")||o(".wp-color-result.wp-picker-open",this.$el).click()},updateColorPicker:function(t,e){var s,a;s=o(t.target).data("name"),a=e?e.color.toString():"",this.save(s,a)},clearColorPicker:function(t){var e=o(t.target).prev().data("name");this.save(e,"")},updateSelectorValue:function(t){var e,s,a,i,n;t&&t.preventDefault&&t.preventDefault(),s=(e=o(t.currentTarget)).data("selector-name"),a=o("[data-name="+s+"]",this.$el).find(".dropdown-toggle"),n=e.data("value"),"icons"===a.data("content-type")?(i=a.data("icon-class"),a.html('<span class="'+i+"-"+(_.isEmpty(n)?a.data("default"):n)+'"></span><span class="caret"></span>')):a.html((_.isEmpty(n)?a.data("default"):n)+' <span class="caret"></span>'),this.save(s,n)},save:function(t,e){if(this.initialization)return!1;this.parent_view.updateSelected(t,e)}}),a=Backbone.View.extend({events:{},first:!1,data:[["A","B","C"]],styles:[],selection:!1,cols_to_add:1,rows_to_add:1,current_theme_class:"",initialize:function(){_.bindAll(this,"save","setSelection","unsetSelection","createCol","removeCol","createRow","removeRow","customContextMenuCallback","buildStyle"),this.$input=this.$el.find(".wpb_vc_param_value"),this.$table=this.$el.find(".vc-table"),this.parseData(),this.render()},render:function(){return this.$table.handsontable({data:this.data,outsideClickDeselects:!1,contextMenu:{callback:this.customContextMenuCallback,items:{row_above_extend:{name:"Insert rows above"},row_below_extend:{name:"Insert rows below"},hsep1:"---------",col_left_extend:{name:"Insert columns on the left"},col_right_extend:{name:"Insert columns on the right"},hsep2:"---------",remove_row:{},remove_col:{},hsep3:"---------",clone_row:{name:"Duplicate this row"},clone_col:{name:"Duplicate this column"}}},afterChange:this.save,afterCreateCol:this.createCol,afterCreateRow:this.createRow,afterRemoveRow:this.removeRow,afterRemoveCol:this.removeCol,afterSelectionEnd:this.setSelection,afterDeselect:this.unsetSelection,afterRender:this.buildStyle}),this.toolbar=(new t).setParentView(this).render(),this.$el.prepend(this.toolbar.$el),this.toolbar.afterAppend(),this.hot=this.$table.handsontable("getInstance"),this.setHandsontableOuterHeight(this.hot),this.buildStyle(),this.setupThemeControl(),this},setupThemeControl:function(){var t,e;e=(t=this.$el.closest(".wpb_el_type_table_param").prev().find("[name=vc_table_theme]")).val(),_.isEmpty(e)||(this.current_theme_class="vc-table-plugin-theme-"+e,o("table",this.$el).addClass(this.current_theme_class)),t.on("change",o.proxy(function(t){var e=o("table",this.$el),s=o(t.target).val();this.current_theme_class.length&&e.removeClass(this.current_theme_class),_.isEmpty(s)?this.current_theme_class="":(this.current_theme_class="vc-table-plugin-theme-"+o(t.target).val(),e.addClass(this.current_theme_class)),this.hot.render()},this)),this.hot.render()},setHandsontableOuterHeight:function(t){_.extend(t.view.wt.wtDom,{outerHeight:function(t){var e="TABLE"===t.tagName?5:0;return this.hasCaptionProblem()&&t.firstChild&&"CAPTION"===t.firstChild.nodeName?t.offsetHeight+t.firstChild.offsetHeight+e:t.offsetHeight+e}})},parseData:function(){var t=this.$input.val(),e=[[],[],[]];t.length&&(this.data=window.vc_table_param_parse_value(t),e=window.vc_table_param_parse_value_data(t)),_.each(e,function(t){var e=_.map(t,function(t){return _.isUndefined(t.cell_attributes)?{}:this.parseAttr(t.cell_attributes)},this);this.styles.push(e)},this)},saveData:function(t){var e;return e=_.map(this.data,function(t,a){return _.map(t,function(t,e){var s;return s=this.styles[a][e],(_.isEmpty(s)?"":"["+this.compactAttr(s)+"]")+(_.isNull(t)?"":window.encodeURIComponent(t))},this).join(",")},this).join("|"),!0!==t&&this.$input.val(e),e},setCellStyle:function(t,e){var s,a,i;a=(s=o(this.hot.getCell(t,e))).text(),i=this.buildCssStyles(this.styles[t][e]),0===t&&s.parent().addClass("vc-th"),s.html('<div class="vc_table_content"></div>').find(".vc_table_content").text(a),s.attr({style:i.css_style.join(""),class:i.css_class.join(" ")})},buildStyle:function(){this.hot&&_.each(this.data,function(t,s){_.each(t,function(t,e){this.setCellStyle(s,e)},this)},this)},buildCssStyles:function(t){var s,a;return s=[],a=["vc_table_cell"],_.each(t,function(t,e){"b"===e&&"b"===t?s.push("font-weight: bold;"):"u"===e&&"u"===t?s.push("text-decoration: underline;"):"i"===e&&"i"===t?s.push("font-style: italic;"):"s"===e&&"s"===t?a.push("vc_stroked"):"font"===e?(s.push("font-size:"+t+";"),s.push("line-height:"+t+";")):"color"===e?s.push("color: "+t+";"):"bgcolor"===e?s.push("background-color:"+t+";"):"borders"===e?a.push(t.join(" ")):"align"===e?s.push("text-align:"+t+";"):"valign"===e&&s.push("vertical-align:"+t+";")},this),{css_class:a,css_style:s}},compactAttr:function(t){return _.compact(_.map(t,function(t,e){return"b"!==e&&"u"!==e&&"i"!==e&&"s"!==e||!1===t?"font"===e?t:"color"===e?"c"+t:"bgcolor"===e?"bg"+t:"align"===e?"align-"+t:"valign"===e?"valign-"+t:"borders"===e?t.join(";"):void 0:t})).join(";")},parseAttr:function(t){var e,s;return e={},s=["border_left","border_right","border_top","border_bottom","borders_all"],_.each(t,function(t){"b"===t?e[t]=t:"u"===t?e[t]=t:"i"===t?e[t]=t:"s"===t?e[t]=t:t.match(/px$/)?e.font=t:t.match(/^c/)?e.color=t.replace(/^c/,""):t.match(/^bg/)?e.bgcolor=t.replace(/^bg/,""):t.match(/^align\-/)?e.align=t.replace(/^align\-/,""):t.match(/^valign\-/)?e.valign=t.replace(/^valign\-/,""):-1<_.indexOf(s,t)&&(_.isUndefined(e.borders)&&(e.borders=[]),e.borders.push(t))}),e},setSelection:function(){this.selection=this.hot.getSelected();var t=this.styles[this.selection[0]][this.selection[1]];this.toolbar.build(t||{})},unsetSelection:function(){return!1},createCol:function(t){for(var e=[t,0],s=0;s<this.cols_to_add;s++)e.push({});this.styles=_.map(this.styles,function(t){return Array.prototype.splice.apply(t,e),t},this),this.saveData()},createColRight:function(){var t,e;t=window.prompt(i18nVcTable.enter_cols_count,1),e=this.selection[1],0<parseInt(t,10)&&(this.cols_to_add=parseInt(t,10),this.hot.alter("insert_col",e+1,this.cols_to_add,null,!0))},createColLeft:function(){var t,e;t=window.prompt(i18nVcTable.enter_cols_count,1),e=this.selection[1],0<parseInt(t,10)&&(this.cols_to_add=parseInt(t,10),this.hot.alter("insert_col",e,this.cols_to_add,null,!0))},removeCol:function(e){this.styles=_.map(this.styles,function(t){return t.splice(e,1),t}),this.saveData()},createRow:function(t){for(var e=[t,0],s=0;s<this.rows_to_add;s++)e.push(new Array(this.styles.length?this.styles[0].length:0));Array.prototype.splice.apply(this.styles,e),this.saveData()},createRowAbove:function(){var t,e;t=window.prompt(i18nVcTable.enter_rows_count,1),e=this.selection[0],0<parseInt(t,10)&&(this.rows_to_add=parseInt(t,10),this.hot.alter("insert_row",e,this.rows_to_add,null,!0))},createRowBelow:function(){var t,e;t=window.prompt(i18nVcTable.enter_rows_count,1),e=this.selection[0],0<parseInt(t,10)&&(this.rows_to_add=parseInt(t,10),this.hot.alter("insert_row",e+1,this.rows_to_add,null,!0))},removeRow:function(t){return this.styles.splice(t,1),this.saveData(),!0},customContextMenuCallback:function(t){"clone_row"===t?this.cloneRow(1):"clone_col"===t?this.cloneCol(1):"row_above_extend"===t?this.createRowAbove():"row_below_extend"===t?this.createRowBelow():"col_right_extend"===t?this.createColRight():"col_left_extend"===t&&this.createColLeft()},cloneRow:function(t){var e,s;s=(e=this.selection[0])+t,this.hot.alter("insert_row",s,1,null,!0),this.data[s]=_.extend([],this.data[e]),this.styles[s]=_.extend([],this.styles[e]),this.hot.loadData(this.data),this.saveData()},cloneCol:function(t){var e,s;e=this.selection[1],s=e+t,this.hot.alter("insert_col",s,1,null,!0),this.data=_.map(this.data,function(t){return t[s]=""+t[e],t}),this.styles=_.map(this.styles,function(t){return t[s]=_.extend({},t[e]),t}),this.hot.loadData(this.data),this.saveData()},save:function(t,e){"loadData"!==e&&this.saveData()},updateSelected:function(t,e){var s,a;s=0;for(var i=this.selection[0];i<=this.selection[2];i++){a=0;for(var n=this.selection[1];n<=this.selection[3];n++){if("border"===t){var o,l;o=!_.isUndefined(this.styles[i])&&_.isObject(this.styles[i][n])&&_.isArray(this.styles[i][n].borders)?this.styles[i][n].borders:[],l=this.setBorders(s,a,_.isString(e)?e:"",o),this.styles[i][n]=_.extend({},this.styles[i][n],{borders:l})}else{var r={};r[t]=e,this.styles[i][n]=_.extend({},this.styles[i][n],r)}this.setCellStyle(i,n),a++}s++}this.saveData()},setBorders:function(t,e,s,a){return"left"===s||"right"===s||"top"===s||"bottom"===s?a.push("border_"+s):"vert"===s?(a.push("border_left"),a.push("border_right")):"hor"===s?(a.push("border_top"),a.push("border_bottom")):"all"===s?a.push("borders_all"):"inner"===s?(0<e&&a.push("border_left"),t<this.selection[2]-this.selection[0]&&a.push("border_bottom")):"outer"===s?(0===e&&a.push("border_left"),this.selection[3]-this.selection[1]>=e&&a.push("border_right"),0===t&&a.push("border_top"),this.selection[2]-this.selection[0]>=t&&a.push("border_bottom")):a=[],a}});o(".vc-theme-selector [data-value]").on("click",function(t){var e,s,a,i;t&&t.preventDefault&&t.preventDefault(),s=(e=o(this)).data("value"),a=e.data("selector-name"),(i=o("[data-name="+a+"]").find(".dropdown-toggle")).html('<span class="'+i.data("icon-class")+"-"+s+'"></span><span class="caret"></span>'),o("[name="+a+"]").val(s).trigger("change")}),_.extend(vc.atts.table_param,{parse:function(t){return this.content().find('input.wpb_vc_param_value[name="'+t.param_name+'"]').data("vcFieldManager").saveData()},init:function(t,e){var s=this;_.isUndefined(vc.edit_element_block_view.ajax)?o(".vc-table-param",s.content()).each(function(){var t=new a({el:this});t.$input.data("vcFieldManager",t)}):vc.edit_element_block_view.$el.off("vcPanel.shown.tableParam").on("vcPanel.shown.tableParam",function(){o(".vc-table-param",s.content()).each(function(){var t=new a({el:this});t.$input.data("vcFieldManager",t)})})}}),o(".dropdown-toggle").dropdown()}(window.jQuery);